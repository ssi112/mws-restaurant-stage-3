var restaurantCuisines,restaurantNeighborhoods,allRestaurants;"undefined"==typeof idb&&self.importScripts("lib/idb.js");const dbVERSION=1,dbNAME="restaurant_reviews",dbOBJECTSTORE="reviews",PORT=1337;class DBHelper{static get DATABASE_URL(){return`http://localhost:${PORT}/restaurants`}static get DATABASE_REVIEWS_URL(){return`http://localhost:${PORT}/reviews/?restaurant_id=`}static openIDB(){return navigator.serviceWorker?(self.indexedDB||reject("Uh oh, IndexedDB is NOT supported in this browser!"),idb.open(dbNAME,dbVERSION,function(e){switch(dbVERSION){case 0:case 1:e.createObjectStore(dbOBJECTSTORE,{keyPath:"id"}).createIndex("restID","id")}})):Promise.resolve()}static storeAllInIDB(e){return DBHelper.openIDB().then(function(t){if(t){var r=t.transaction(dbOBJECTSTORE,"readwrite"),n=r.objectStore(dbOBJECTSTORE);return e.forEach(function(e){n.put(e)}),r.complete}})}static getFromAPIsaveToIDB(){return fetch(DBHelper.DATABASE_URL).then(function(e){return e.json()}).then(e=>(DBHelper.storeAllInIDB(e),e))}static getAllFromIDB(){return DBHelper.openIDB().then(function(e){if(e)return e.transaction(dbOBJECTSTORE).objectStore(dbOBJECTSTORE).getAll()})}static getNeighborhoodsCuisinesSelect(e){const t=e.map((t,r)=>e[r].neighborhood);restaurantNeighborhoods=t.filter((e,r)=>t.indexOf(e)==r);const r=e.map((t,r)=>e[r].cuisine_type);restaurantCuisines=r.filter((e,t)=>r.indexOf(e)==t),allRestaurants=e}static fetchRestaurants(e){return DBHelper.getAllFromIDB().then(e=>e.length?Promise.resolve(e):DBHelper.getFromAPIsaveToIDB()).then(t=>{DBHelper.getNeighborhoodsCuisinesSelect(t),e(null,t)}).catch(t=>{e(t,null)})}static fetchRestaurantById(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.find(t=>t.id==e);r?t(null,r):t(`Restaurant with ID=${e} does not exist`,null)}})}static getRestaurantReviewsById(e,t){let r=DBHelper.DATABASE_REVIEWS_URL+e;fetch(r).then(e=>{e.ok||console.log(`Problem retrieving reviews: ${e.statusText}`),e.json().then(e=>{t(null,e)})}).catch(e=>t(e,null))}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.cuisine_type==e);t(null,r)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.neighborhood==e);t(null,r)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r){DBHelper.fetchRestaurants((n,s)=>{if(n)r(n,null);else{let n=s;"all"!=e&&(n=n.filter(t=>t.cuisine_type==e)),"all"!=t&&(n=n.filter(e=>e.neighborhood==t)),r(null,n)}})}static fetchNeighborhoods(e){restaurantNeighborhoods?e(null,restaurantNeighborhoods):DBHelper.fetchRestaurants((t,r)=>{t?e(t,null):e(null,restaurantNeighborhoods)})}static fetchCuisines(e){restaurantCuisines?e(null,restaurantCuisines):DBHelper.fetchRestaurants((t,r)=>{t?e(t,null):e(null,restaurantCuisines)})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return e.photograph?`/img/${e.photograph}.jpg`:"/img/default-annie-spratt.jpg"}static mapMarkerForRestaurant(e,t){const r=new L.marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name,url:DBHelper.urlForRestaurant(e)});return r.addTo(newMap),r}}self.DBHelper=DBHelper;