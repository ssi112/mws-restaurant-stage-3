var restaurantCuisines,restaurantNeighborhoods,allRestaurants;const dbVERSION=1,dbNAME="restaurant_reviews",dbRestaurantOBJECTSTORE="restaurants",dbReviewsOBJECTSTORE="reviews",PORT=1337;class DBHelper{static get DATABASE_URL(){return`http://localhost:${PORT}/restaurants`}static get DATABASE_REVIEWS_URL(){return`http://localhost:${PORT}/reviews/?restaurant_id=`}static openIDB(){return navigator.serviceWorker?(self.indexedDB||reject("Uh oh, IndexedDB is NOT supported in this browser!"),idb.open(dbNAME,dbVERSION,function(e){switch(dbVERSION){case 0:case 1:e.createObjectStore(dbRestaurantOBJECTSTORE,{keyPath:"id"}).createIndex("restID","id");case 2:var t=e.createObjectStore(dbReviewsOBJECTSTORE,{keyPath:"id"});t.createIndex("reviewID","id"),t.createIndex("restID","restaurant_id")}})):Promise.resolve()}static getFromAPIsaveToIDB(){return fetch(DBHelper.DATABASE_URL).then(function(e){return e.json()}).then(e=>(DBHelper.storeAllInIDB(e),e))}static storeAllInIDB(e){return DBHelper.openIDB().then(function(t){if(t){var r=t.transaction(dbRestaurantOBJECTSTORE,"readwrite"),n=r.objectStore(dbRestaurantOBJECTSTORE);return e.forEach(function(e){n.put(e)}),r.complete}})}static getAllFromIDB(){return DBHelper.openIDB().then(function(e){if(e)return e.transaction(dbRestaurantOBJECTSTORE).objectStore(dbRestaurantOBJECTSTORE).getAll()})}static getNeighborhoodsCuisinesSelect(e){const t=e.map((t,r)=>e[r].neighborhood);restaurantNeighborhoods=t.filter((e,r)=>t.indexOf(e)==r);const r=e.map((t,r)=>e[r].cuisine_type);restaurantCuisines=r.filter((e,t)=>r.indexOf(e)==t),allRestaurants=e}static fetchRestaurants(e){return DBHelper.getAllFromIDB().then(e=>e.length?Promise.resolve(e):DBHelper.getFromAPIsaveToIDB()).then(t=>{DBHelper.getNeighborhoodsCuisinesSelect(t),e(null,t)}).catch(t=>{e(t,null)})}static fetchRestaurantById(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.find(t=>t.id==e);r?t(null,r):t(`Restaurant with ID=${e} does not exist`,null)}})}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.cuisine_type==e);t(null,r)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.neighborhood==e);t(null,r)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r){DBHelper.fetchRestaurants((n,a)=>{if(n)r(n,null);else{let n=a;"all"!=e&&(n=n.filter(t=>t.cuisine_type==e)),"all"!=t&&(n=n.filter(e=>e.neighborhood==t)),r(null,n)}})}static fetchNeighborhoods(e){restaurantNeighborhoods?e(null,restaurantNeighborhoods):DBHelper.fetchRestaurants((t,r)=>{t?e(t,null):e(null,restaurantNeighborhoods)})}static fetchCuisines(e){restaurantCuisines?e(null,restaurantCuisines):DBHelper.fetchRestaurants((t,r)=>{t?e(t,null):e(null,restaurantCuisines)})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return e.photograph?`/img/${e.photograph}.jpg`:"/img/default-annie-spratt.jpg"}static updateIsFavorite(e,t){DBHelper.openIDB().then(function(r){let n=r.transaction(dbRestaurantOBJECTSTORE,"readwrite").objectStore(dbRestaurantOBJECTSTORE);n.get(e).then(e=>{e.is_favorite=t,n.put(e)})}),DBHelper.updateIsFavoriteAPI(e,t)}static updateIsFavoriteAPI(e,t){let r=`${DBHelper.DATABASE_URL}/${e}/?is_favorite=${t}`;if(navigator.onLine)return console.log(`updateIsFavoriteAPI: You are currently online. Prepare to fetch! ${r}`),new Promise(function(n,a){fetch(r,{method:"PUT"}).then(()=>{console.log(`updateIsFavoriteAPI: PUT: restaurantID: ${e} : is_favorite: ${t}`),n(!0)}).catch(r=>{console.log(`PUT: restaurantID:${e} : is_favorite:${t} \n Fetch Error: ${r}`)})});console.log("updateIsFavoriteAPI: You are currently offline! Saving in local storage,"),DBHelper.storeFavoriteTillOnline(e,r)}static storeFavoriteTillOnline(e,t){console.log(`storeFavoriteTillOnline: ${t}`),localStorage.setItem(e,t),window.addEventListener("online",e=>{console.log("online event, yay!"),DBHelper.moveLocalStorageToAPI()})}static moveLocalStorageToAPI(){let e="";Object.keys(localStorage).forEach(t=>{e=localStorage.getItem(t),console.log(e),fetch(e,{method:"PUT"})}),Object.keys(localStorage).forEach(e=>{localStorage.removeItem(e)})}static mapMarkerForRestaurant(e,t){const r=new L.marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name,url:DBHelper.urlForRestaurant(e)});return r.addTo(newMap),r}static getAndStoreAllReviews(e){e.forEach(e=>{DBHelper.getReviewsFromAPIsaveToIDB(e)})}static getReviewsFromAPIsaveToIDB(e){let t=`${DBHelper.DATABASE_REVIEWS_URL}${e}`;return fetch(t).then(function(e){return e.json()}).then(e=>(DBHelper.storeAllReviewsInIDB(e),e)).catch(e=>{console.log(`getReviewsFromAPIsaveToIDB():Error: ${e}`)})}static storeAllReviewsInIDB(e){return DBHelper.openIDB().then(function(t){if(t){var r=t.transaction(dbReviewsOBJECTSTORE,"readwrite"),n=r.objectStore(dbReviewsOBJECTSTORE);return e.forEach(function(e){n.put(e)}),r.complete}})}static getRestaurantReviewsById(e,t){DBHelper.getReviewFromIDB(e).then(r=>{if(r.length)console.log(`DBHelper.getReviewFromIDB(id)=${e}`),t(null,r);else{let r=DBHelper.DATABASE_REVIEWS_URL+e;fetch(r).then(e=>{e.ok||console.log(`Problem retrieving reviews: ${e.statusText}`),e.json().then(e=>{console.log(`fetch(getURL)=${r}`),t(null,e)})}).catch(e=>t(e,null))}})}static getReviewFromIDB(e){return DBHelper.openIDB().then(function(t){if(!t)return null;return t.transaction(dbReviewsOBJECTSTORE).objectStore(dbReviewsOBJECTSTORE).index("restID").getAll(e)})}}self.DBHelper=DBHelper;