let restaurant;var newMap,apiKey=config.MapBoxKey;function convertTimeStamp(e){let t=new Date(e),n=t.getMonth(),r=(t.getDay(),t.getDate()),a=t.getFullYear();return`${["January","February","March","April","May","June","July","August","September","October","November","December"][n]} ${r}, ${a}`}function showReviewForm(e){let t=e?"block":"none";navigator.onLine?document.getElementById("offline").style.display="none":document.getElementById("offline").style.display="block",document.getElementById("review_form").style.display=t,document.getElementById("name").focus()}function checkReviewForm(){let e=document.forms.review_form;if(validateForm(e)){let t=e.name.value,n=e.rating.value,r=e.comments.value;restaurant=self.restaurant;let a=new Date,o={restaurant_id:restaurant.id,name:t,rating:parseInt(n,10),comments:r,createdAt:a,updatedAt:a};DBHelper.putReviewInAPI(o),clearForm(),showReviewForm(!1),addNewReviewToPage(o)}}function validateForm(e){let t=0,n=document.getElementById("nameError"),r=document.getElementById("ratingError"),a=document.getElementById("reviewError");return""==e.name.value.trim()?(n.innerHTML="Please enter your name!",++t):n.innerHTML="",checkRange(e.rating.value,1,5)?r.innerHTML="":(r.innerHTML="Oops! Invalid rating",++t),""==e.comments.value.trim()?(a.innerHTML="Please enter comments!",++t):a.innerHTML="",!t}function checkRange(e,t,n){return num=parseInt(e,10),!isNaN(num)&&num>=t&&num<=n}function clearForm(){document.forms.review_form.reset(),clearErrorMessages()}function clearErrorMessages(){let e=document.getElementById("nameError"),t=(document.getElementById("ratingError"),document.getElementById("reviewError"));e.innerHTML="",t.innerHTML="",t.innerHTML=""}function characterCount(){let e=document.getElementById("comments"),t=e.getAttribute("maxlength");t||(t=512);let n=t-e.value.length;document.getElementById("charCountMsg").innerHTML=`Characters remaining: ${n}`}document.addEventListener("DOMContentLoaded",e=>{window.initMap()}),window.onload=function(){navigator.onLine&&DBHelper.moveLocalStorageToAPI()},initMap=(()=>{fetchRestaurantFromURL((e,t)=>{e?console.error(e):(self.newMap=L.map("map",{center:[t.latlng.lat,t.latlng.lng],zoom:16,scrollWheelZoom:!1}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token="+apiKey,{maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery ï¿½ <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(newMap),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.newMap))})}),fetchRestaurantFromURL=(e=>{if(self.restaurant)return void e(null,self.restaurant);const t=getParameterByName("id");t?DBHelper.fetchRestaurantById(t,(t,n)=>{self.restaurant=n,n?(fillRestaurantHTML(),e(null,n)):console.error(t)}):(error="No restaurant id in URL",e(error,null))}),fillRestaurantHTML=((e=self.restaurant)=>{document.getElementById("restaurant-name").innerHTML=e.name,document.getElementById("restaurant-address").innerHTML=e.address;const t=document.getElementById("restaurant-img");t.className="restaurant-img lazyload",t.src=responsiveImgSRC(e),t.setAttribute("data-src",responsiveImgSRC(e)),t.srcset=responsiveImgSRCSET(e),t.alt=`image of ${e.name}`,t.title=`You could be dining at ${e.name}`,document.getElementById("figure-caption").innerHTML=e.name,document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&fillRestaurantHoursHTML(),DBHelper.getRestaurantReviewsById(e.id,fillReviewsHTML)}),responsiveImgSRC=(e=>{let t=DBHelper.imageUrlForRestaurant(e),n=t.indexOf(".jpg");return t=t.slice(0,n)+"_320px"+t.slice(n)}),responsiveImgSRCSET=(e=>{let t=DBHelper.imageUrlForRestaurant(e),n=t.lastIndexOf("."),r=`${t.slice(0,n)}_320px.jpg 320w,`;return r+=`\n ${t.slice(0,n)}_480px.jpg 480w,`,r+=`\n ${t.slice(0,n)}.jpg 800w`}),fillRestaurantHoursHTML=((e=self.restaurant.operating_hours)=>{const t=document.getElementById("restaurant-hours");for(let n in e){const r=document.createElement("tr"),a=document.createElement("td");a.innerHTML=n,r.appendChild(a);const o=document.createElement("td");o.innerHTML=e[n],r.appendChild(o),t.appendChild(r)}}),fillReviewsHTML=((e,t=self.restaurant.reviews)=>{const n=document.getElementById("reviews-container"),r=document.createElement("h2");if(r.innerHTML="Reviews",n.appendChild(r),!t){const e=document.createElement("p");return e.innerHTML=`No reviews yet for restaurant with ID = ${self.restaurant.id}`,void n.appendChild(e)}t.sort(function(e,t){return t.updateDate=new Date(t.updatedAt),e.updateDate=new Date(e.updatedAt),t.updateDate-e.updateDate});const a=document.getElementById("reviews-list");t.forEach(e=>{a.appendChild(createReviewHTML(e))}),n.appendChild(a)}),createReviewHTML=(e=>{const t=document.createElement("li"),n=document.createElement("div");t.appendChild(n);const r=document.createElement("h2");r.className="align-left",r.innerHTML=e.name,n.appendChild(r);const a=document.createElement("h2");a.className="align-right",a.innerHTML=convertTimeStamp(e.updatedAt),n.appendChild(a);const o=document.createElement("br");o.className="clear-both",n.appendChild(o);const i=document.createElement("p");i.className="rating",i.innerHTML=`Rating: ${e.rating}`,t.appendChild(i);const l=document.createElement("p");return l.className="rating-comments",l.innerHTML=e.comments,t.appendChild(l),t}),addNewReviewToPage=(e=>{document.getElementById("reviews-container");let t=document.getElementById("reviews-list");t.insertBefore(createReviewHTML(e),t.firstChild)}),fillBreadcrumb=((e=self.restaurant)=>{const t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=` / ${e.name}`,t.appendChild(n)}),getParameterByName=((e,t)=>{t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");const n=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null});